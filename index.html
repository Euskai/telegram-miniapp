<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Plataforma YouTube</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { 
            font-family: sans-serif; 
            background-color: var(--tg-theme-bg-color, #fff); 
            color: var(--tg-theme-text-color, #000); 
            padding: 20px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .btn { 
            display: block; 
            width: 100%; 
            padding: 15px; 
            background-color: var(--tg-theme-button-color, #3390ec); 
            color: var(--tg-theme-button-text-color, #fff); 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: bold;
            cursor: pointer; 
            transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .input-group { margin-bottom: 5px; }
        input { 
            width: 100%; 
            padding: 12px; 
            box-sizing: border-box; 
            border-radius: 8px; 
            border: 1px solid var(--tg-theme-hint-color, #ccc); 
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000);
        }
        h3 { text-align: center; margin-bottom: 20px; }
    </style>
</head>
<body>
    <h3>üéõÔ∏è Panel de Control</h3>
    
    <button class="btn" onclick="sendToN8n('informaci√≥n y estad√≠sticas')">üìä Ver Estad√≠sticas</button>
    <button class="btn" onclick="sendToN8n('lista de canales')">üì∫ Mis Canales</button>
    <button class="btn" onclick="sendToN8n('descargar audio')">üéß Descargar Audio</button>

    <hr style="width: 100%; border: 0; border-top: 1px solid var(--tg-theme-hint-color, #eee); margin: 20px 0;">

    <div class="input-group">
        <input type="text" id="urlInput" placeholder="Pega aqu√≠ la URL del video...">
    </div>
    <button class="btn" onclick="sendCustomAction()">Enviar URL / Comando</button>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand(); // Expande la app para usar toda la pantalla disponible

        // ‚úÖ TU URL DE N8N INTEGRADA
        const N8N_WEBHOOK_URL = 'https://n8n.euskai.net/webhook-test/6ebdbb22-5823-44ee-a6c4-d6490db79e2f'; 

      function sendToN8n(actionText) {
            // Usamos 'let' en lugar de 'const' para poder modificarlo si hace falta
            let user = tg.initDataUnsafe.user;
            
            // --- CORRECCI√ìN PARA PRUEBAS ---
            if (!user) {
                // Si no detecta Telegram, usamos el usuario de prueba y SEGUIMOS ADELANTE
                console.log("Modo prueba: Usando usuario simulado");
                user = { 
                    id: 6735676248, 
                    username: 'test_user', 
                    first_name: 'Test' 
                };
                
                // He quitado el 'return' para que el c√≥digo contin√∫e ejecut√°ndose
            }
            // -------------------------------

            // Efecto visual de carga
            tg.MainButton.showProgress();

            const payload = {
                user_id: user.id,
                username: user.username || 'Anonimo',
                first_name: user.first_name,
                action: actionText 
            };

            fetch(N8N_WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(response => {
                tg.MainButton.hideProgress();
                if (response.ok) {
                    // Solo cerramos la app si estamos realmente en Telegram
                    if (tg.initDataUnsafe.user) {
                        tg.close();
                    } else {
                        alert("‚úÖ Enviado correctamente a n8n (Modo Prueba)");
                    }
                } else {
                    alert('‚ùå Error en n8n: ' + response.status);
                }
            })
            .catch(error => {
                tg.MainButton.hideProgress();
                alert('‚ùå Error de conexi√≥n. ¬øEst√° el workflow activo?');
                console.error(error);
            });
        }

        function sendCustomAction() {
            const text = document.getElementById('urlInput').value;
            if(text.trim()) {
                sendToN8n(text); 
            } else {
                alert("Por favor escribe algo o pega una URL.");
            }
        }
    </script>
</body>
</html>