<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>YTnews UI</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --accent: #7d5fff; --bg: #17212b; --yellow: #ffff00; 
            --bot-bubble: #242f3d; --user-bubble: #2b5278; --user-name: #4ecb71; 
        }
        
        body { 
            font-family: -apple-system, sans-serif; background-color: var(--bg); color: white; 
            margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; 
        }
        
        /* √Årea de Chat */
        #chat-window { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
        
        .bubble { padding: 10px 14px; border-radius: 12px; max-width: 80%; line-height: 1.4; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .bot-msg { align-self: flex-start; background-color: var(--bot-bubble); border-bottom-left-radius: 4px; }
        .user-msg { align-self: flex-end; background-color: var(--user-bubble); border-bottom-right-radius: 4px; text-align: left; }

        .name-label { font-weight: bold; font-size: 11px; margin-bottom: 4px; text-transform: uppercase; }
        .user-label { color: var(--user-name); }
        .bot-label { color: var(--accent); }

        /* Contenedor Inferior Fijo */
        #footer-container { position: sticky; bottom: 0; width: 100%; z-index: 100; background: #0e1621; border-top: 1px solid #2b394a; }
        
        .input-row { display: flex; padding: 10px 15px; gap: 12px; align-items: center; }
        
        #msg-input { 
            flex-grow: 1; background: #242f3d; border: 1px solid #3b4754; 
            border-radius: 20px; color: white; padding: 10px 15px; font-size: 16px; outline: none; 
        }
        
        .icon-btn { background: none; border: none; font-size: 22px; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; }

        #btn-menu-footer { 
            background-color: var(--yellow); color: #000; border: none; 
            font-weight: 800; padding: 18px; width: 100%; font-size: 16px; 
            cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
        }

        /* Overlay y Men√∫ Flotante */
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 150; }
        #modal-menu { 
            display: none; position: fixed; bottom: 140px; left: 50%; transform: translateX(-50%); 
            background: #1c2733; padding: 20px; border-radius: 20px; width: 85%; 
            z-index: 200; flex-direction: column; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
        }
        .active { display: flex !important; }

        /* Botones del Men√∫ */
        .grid-btn { background: #2b3744; border: none; color: #fff; padding: 14px 5px; border-radius: 12px; font-size: 11px; font-weight: 600; flex: 1; cursor: pointer; }
        .row { display: flex; gap: 8px; width: 100%; }
    </style>
</head>
<body>

    <div id="chat-window">
        <div class="bubble bot-msg"><div class="name-label bot-label">YTnews</div>Sistema conectado. Esperando comandos...</div>
    </div>

    <div id="footer-container">
        <div class="input-row">
            <input type="text" id="msg-input" placeholder="Escribe aqu√≠...">
            <button class="icon-btn" onclick="enviarTexto()" style="color: #4facfe;">‚û§</button>
            <button id="mic-btn" class="icon-btn" onclick="toggleGrabacion()" style="color: #ff4d4d;">üéôÔ∏è</button>
        </div>
        <button id="btn-menu-footer" onclick="toggleMenu()">MENU</button>
    </div>

    <div id="overlay" onclick="toggleMenu()"></div>

    <div id="modal-menu">
        <div class="row">
            <button class="grid-btn" onclick="ejecutarBoton('Comenzar')">Comenzar</button>
            <button class="grid-btn" onclick="ejecutarBoton('Video Individual')">Video Individual</button>
            <button class="grid-btn" onclick="ejecutarBoton('Extraer Canal')">Extraer Canal</button>
        </div>
        <button class="grid-btn" style="width:100%" onclick="ejecutarBoton('Extraer Texto / Web')">Extraer Texto / Web</button>
        <div class="row">
            <button class="grid-btn" onclick="ejecutarBoton('Info & Stats')">Info & Stats</button>
            <button class="grid-btn" onclick="ejecutarBoton('Hora Lanzamiento')">Hora Lanzamiento</button>
        </div>
        <div class="row">
            <button class="grid-btn" onclick="ejecutarBoton('Canales')">Canales</button>
            <button class="grid-btn" onclick="ejecutarBoton('A√±adir')">A√±adir</button>
            <button class="grid-btn" onclick="ejecutarBoton('Eliminar')">Eliminar</button>
        </div>
    </div>

    <script>
        const webapp = window.Telegram.WebApp;
        webapp.ready();
        webapp.expand();
        const urlWebhook = 'https://n8n.euskai.net/webhook/tu-id-aqui';

        function toggleMenu() {
            document.getElementById('modal-menu').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        function agregarBurbuja(tipo, nombre, texto) {
            const chat = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `bubble ${tipo === 'bot' ? 'bot-msg' : 'user-msg'}`;
            div.innerHTML = `<div class="name-label ${tipo === 'bot' ? 'bot-label' : 'user-label'}">${nombre}</div>${texto}`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function enviarTexto() {
            const input = document.getElementById('msg-input');
            if(!input.value.trim()) return;
            const msg = input.value;
            agregarBurbuja('user', webapp.initDataUnsafe.user?.first_name || 'T√∫', msg);
            input.value = '';
            llamarWebhook({ tipo: 'texto', contenido: msg });
        }

        function ejecutarBoton(nombre) {
            agregarBurbuja('user', webapp.initDataUnsafe.user?.first_name || 'T√∫', "Comando: " + nombre);
            toggleMenu();
            llamarWebhook({ tipo: 'boton', contenido: nombre });
        }

        function llamarWebhook(datos) {
            fetch(urlWebhook, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...datos, user_id: webapp.initDataUnsafe.user?.id })
            })
            .then(res => res.json())
            .then(d => { if(d.respuesta) agregarBurbuja('bot', 'YTnews', d.respuesta); });
        }

        // --- AUDIO ---
        let rec; let aud = [];
        async function toggleGrabacion() {
            const btn = document.getElementById('mic-btn');
            if (!rec || rec.state === "inactive") {
                try {
                    const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                    rec = new MediaRecorder(s);
                    rec.ondataavailable = e => aud.push(e.data);
                    rec.onstop = () => {
                        const blob = new Blob(aud, { type: 'audio/ogg' });
                        aud = [];
                        agregarBurbuja('user', 'T√∫', 'üé§ Nota de voz enviada');
                        const f = new FileReader();
                        f.readAsDataURL(blob);
                        f.onloadend = () => llamarWebhook({ tipo: 'audio', contenido: f.result });
                    };
                    rec.start(); btn.innerText = "üõë";
                } catch(e) { alert("Permite el micro para grabar."); }
            } else { rec.stop(); btn.innerText = "üéôÔ∏è"; }
        }
    </script>
</body>
</html>
